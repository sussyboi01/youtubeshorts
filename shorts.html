<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Google Slides</title>
<link rel="icon" href="https://gstatic.com/docs/presentations/images/presentations_logo144.png" type="image/png">

<style>
  :root { --bg:#0b0b0b; --panel:rgba(0,0,0,0.45); --text:#fff; --accent:#ff3b30; }
  :root.light { --bg:#f6f7fb; --panel:rgba(255,255,255,0.75); --text:#111; --accent:#e64b3b; }

  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:Inter,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden; }
  #stack { height:300vh; width:100%; overflow:visible; scroll-behavior:smooth; }

  .slot {
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    flex-direction: row;
  }
   
  .player-frame {
    width: 360px;
    height: 640px;
    border-radius: 16px;
    overflow: hidden;
    background: #000;
    box-shadow: 0 10px 30px rgba(0,0,0,.6);
    border: 1px solid rgba(255,255,255,.03);
    flex-shrink: 0;
  }
  .player-frame iframe { width:100%; height:100%; border:none; }

  #ui {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
    background: var(--panel);
    padding: 12px;
    border-radius: 12px;
    backdrop-filter: blur(6px);
    min-width: 120px;
    flex-shrink: 0;
  }

  .btn { background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.06); padding:8px 12px; border-radius:8px; cursor:pointer; text-align:center; }
  .heart { font-size:26px; cursor:pointer; user-select:none; }
  .heart.faved { color:var(--accent); text-shadow:0 2px 8px rgba(0,0,0,.6); }
</style>
</head>
<body>

<div id="stack" tabindex="0" aria-label="Shorts feed">
  <!-- Slot template -->
  <div class="slot" id="slot-prev">
    <div class="player-frame"><iframe id="frame-prev" allow="autoplay; encrypted-media; fullscreen" loading="lazy"></iframe></div>
    <div id="ui">
      <button id="upBtn" class="btn">▲ Up</button>
      <div id="favBtn" class="heart" title="Favorite">♡</div>
      <button id="downBtn" class="btn">▼ Down</button>
      <button id="gotoFav" class="btn">Favorites</button>
      <button id="gotoYT" class="btn">Youtube</button>
    </div>
  </div>

  <div class="slot" id="slot-cur">
    <div class="player-frame"><iframe id="frame-cur" allow="autoplay; encrypted-media; fullscreen" loading="lazy"></iframe></div>
    <div id="ui">
      <button id="upBtn" class="btn">▲ Up</button>
      <div id="favBtn" class="heart" title="Favorite">♡</div>
      <button id="downBtn" class="btn">▼ Down</button>
      <button id="gotoFav" class="btn">Favorites</button>
      <button id="gotoYT" class="btn">Youtube</button>
    </div>
  </div>

  <div class="slot" id="slot-next">
    <div class="player-frame"><iframe id="frame-next" allow="autoplay; encrypted-media; fullscreen" loading="lazy"></iframe></div>
    <div id="ui">
      <button id="upBtn" class="btn">▲ Up</button>
      <div id="favBtn" class="heart" title="Favorite">♡</div>
      <button id="downBtn" class="btn">▼ Down</button>
      <button id="gotoFav" class="btn">Favorites</button>
      <button id="gotoYT" class="btn">Youtube</button>
    </div>
  </div>
</div>

<script>
let feed=[], curIdx=0;

const framePrev=document.getElementById('frame-prev');
const frameCur=document.getElementById('frame-cur');
const frameNext=document.getElementById('frame-next');

function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function buildEmbed(id){
  const p = new URLSearchParams();
  p.set('rel','0');
  p.set('autoplay','1');
  p.set('mute','0');
  p.set('enablejsapi','1');
  p.set('playsinline','1');
  return `https://www.youtube.com/embed/${id}?${p.toString()}`;
}

// Preload frames
function setFrame(f,id,isCurrent=false){
  if(!id){ f.src='about:blank'; return; }
  f.dataset.video=id;
  f.src=buildEmbed(id);
  f.onload = ()=>{
    if(isCurrent) postCommand(f,'playVideo'); 
    else postCommand(f,'pauseVideo');
  };
}

function rotateForward(){
  if(curIdx>=feed.length-1) return;
  curIdx++;
  setFrame(framePrev, feed[curIdx-1], false);
  setFrame(frameCur, feed[curIdx], true);
  setFrame(frameNext, feed[curIdx+1], false);
}

function rotateBackward(){
  if(curIdx<=0) return;
  curIdx--;
  setFrame(framePrev, feed[curIdx-1], false);
  setFrame(frameCur, feed[curIdx], true);
  setFrame(frameNext, feed[curIdx+1], false);
}

function postCommand(frame,command){
  if(!frame||!frame.contentWindow) return;
  frame.contentWindow.postMessage(JSON.stringify({event:'command',func:command,args:[]}),'*');
}

/* Buttons */
document.querySelectorAll('.btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(btn.id==='upBtn') rotateBackward();
    if(btn.id==='downBtn') rotateForward();
    if(btn.id==='gotoFav') window.location='favorites.html';
    if(btn.id==='gotoYT') window.location='index.html';
  });
});

document.querySelectorAll('.heart').forEach(h=>{
  h.addEventListener('click',()=>{
    const id = feed[curIdx];
    if(!id) return;
    let f = JSON.parse(localStorage.getItem('favshorts')||'[]');
    if(f.includes(id)) f=f.filter(x=>x!==id); else f.push(id);
    localStorage.setItem('favshorts', JSON.stringify(f));
  });
});

/* Keyboard/Wheel navigation */
window.addEventListener('wheel', e=>{ if(e.deltaY>40) rotateForward(); else if(e.deltaY<-40) rotateBackward(); },{passive:false});
window.addEventListener('keydown', e=>{ if(e.key==='ArrowDown') rotateForward(); if(e.key==='ArrowUp') rotateBackward(); });

/* Load feed.json */
async function loadFeed(){
  try{
    const r = await fetch('feed.json',{cache:'no-store'});
    const data = await r.json();
    if(!Array.isArray(data)||data.length===0) return;
    feed = shuffleArray(data); 
    curIdx = 0;
    setFrame(framePrev, feed[curIdx-1], false);
    setFrame(frameCur, feed[curIdx], true);
    setFrame(frameNext, feed[curIdx+1], false);
  }catch(e){console.error(e);}
}
loadFeed();
</script>

<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

</body>
</html>
